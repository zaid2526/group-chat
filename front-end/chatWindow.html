<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- axios cdn -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>

    <title>Chat Window</title>
</head>
<body>
    <h2 id="app">Chat Window</h2>

    <div id="chats" style="align-items: center; width: 65%; height: 45%; background-color: rgb(166, 201, 231); list-style: none;">
    </div>
    <div id="msg" style="list-style:none;">

    </div>

<footer style="margin-top: 15%; ">
    <form onsubmit="sendMsg(event)">
        <label for="msg"></label>
        <input type="text" name="msg">
        <button type="submit" >Send</button>
    </form>
</footer>
<script>
    window.addEventListener('load',users =>{
    axios.get('http://localhost:3030/users')
      .then(response => {
        // console.log(response);
        if(response.status == 200){
            response.data.users.forEach(user => {
                showUsers(user)
                
            });
        }else {
            throw new Error();
        }
      })
      .catch(err => {
        console.log(err)
      })
    
      
    })
    function showUsers(user){
    const parentNode = document.getElementById('chats');
    parentNode.innerHTML += `
      <li>
        ${user.name} join...
      </li>
      `
    }

    async function sendMsg(event){
      event.preventDefault();
      const msg = event.target.msg.value
      // console.log("mssg",msg);
      const obj = {msg}
      const response = await axios.post('http://localhost:3030/message',obj)

        // showMessage(response.data.name,msg)
        event.target.msg.value='';
    }
    const parentNode = document.getElementById('msg');
    function showMessage(name,msg){
      parentNode.innerHTML += `<li>${name}:${msg}</li>`
      
    }
    localStorage.setItem("lastMsgId", 0);
    
    
    window.addEventListener('load',users =>{
      const timer=setInterval(()=>{
        const lastMsgId=localStorage.getItem('lastMsgId')
        console.log('lastMsgId',lastMsgId);
        axios.get(`http://localhost:3030/message/${lastMsgId}`)
      .then(response => {
        const {msgs}=response.data
        // parentNode.innerHTML='';
        if(response.status == 200){
          console.log(msgs);
            msgs.forEach(msg => {
              
              localStorage.setItem("lastMsgId", msg.id);
              showMessage(msg.register.name,msg.message)
            });
        }else {
            throw new Error();
        }
      })
      .catch(err => {
        console.log(err)
      })
      },500)

      // setTimeout(()=>{
      //   clearTimeout(timer)
      // },2000)
    
    })
</script>
</body>
</html>